<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>WOP Statutory Challan Xtract - Income Tax Challan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<!-- ‚úÖ Styled SheetJS (same as ESIC) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg1:#0b1220;
    --bg2:#0f1b33;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e5e7eb;
    --shadow:0 18px 55px rgba(2,6,23,.25);

    --primary:#2563eb;
    --primary2:#1d4ed8;
    --success:#16a34a;
    --danger:#dc2626;

    --theadText:#ffffff;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: "Segoe UI", Arial, sans-serif;
    color: var(--text);
    min-height:100vh;
    background:
      radial-gradient(1200px 600px at 15% 10%, rgba(37,99,235,.25), transparent 55%),
      radial-gradient(900px 500px at 85% 0%, rgba(16,185,129,.18), transparent 55%),
      linear-gradient(160deg, var(--bg1) 0%, var(--bg2) 100%);
    padding: 28px 18px;
  }

  .shell{ max-width:1800px; margin:0 auto; }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    padding:16px 18px;
    border-radius:16px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 35px rgba(0,0,0,.20);
    margin-bottom: 16px;
    flex-wrap:wrap;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    min-width: 280px;
  }

  .brand img{
    width:46px;height:46px;
    border-radius:12px;
    background:#fff;
    padding:6px;
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
    object-fit:contain;
  }

  .brand-title{ display:flex; flex-direction:column; line-height:1.1; }
  .brand-title h1{
    color:#fff;
    font-size:18px;
    font-weight:900;
    letter-spacing:.2px;
  }
  .brand-title p{
    color: rgba(255,255,255,.72);
    font-size:12px;
    margin-top:4px;
  }

  .follow-bar{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .follow-label{
    color: rgba(255,255,255,.75);
    font-size:12px;
    font-weight:800;
  }
  .social-btn{
    text-decoration:none;
    font-weight:900;
    font-size:12px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.08);
    color:#fff;
    transition: transform .08s ease, background .08s ease, opacity .08s ease;
    box-shadow: 0 10px 22px rgba(0,0,0,.15);
  }
  .social-btn:hover{ background: rgba(255,255,255,.14); transform: translateY(-1px); }
  .social-btn:active{ transform: translateY(0); opacity:.92; }
  .social-btn.li{ border-color: rgba(10,102,194,.45); }
  .social-btn.wa{ border-color: rgba(37,211,102,.45); }
  .social-btn.ig{ border-color: rgba(225,48,108,.45); }
  .follow-sep2{ color: rgba(255,255,255,.30); font-weight:900; margin:0 2px; }
  .follow-mail{
    color: rgba(255,255,255,.75);
    font-size:12px;
    font-weight:800;
  }
  .follow-mail a{
    color:#93c5fd;
    text-decoration:none;
    font-weight:900;
  }
  .follow-mail a:hover{ text-decoration:underline; }

  .card{
    background: var(--card);
    border-radius: 18px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(2,6,23,.08);
    overflow:hidden;
  }

  .card-head{
    padding:16px 18px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    flex-wrap:wrap;
  }

  .card-head .left{ display:flex; flex-direction:column; gap:4px; }
  .card-head .left .title{ font-size:14px; font-weight:900; }
  .card-head .left .sub{ font-size:12px; color: var(--muted); }

  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .file{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    min-width: 320px;
  }
  .file span{ color: var(--muted); font-size:12px; white-space:nowrap; font-weight:900; }
  input[type="file"]{ width:100%; font-size:12px; }

  button{
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    padding:10px 14px;
    display:inline-flex;
    gap:8px;
    align-items:center;
    box-shadow: 0 8px 20px rgba(2,6,23,.10);
    transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(2,6,23,.14); }
  button:active{ transform: translateY(0); opacity:.92; }
  button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

  button.primary{ background: linear-gradient(135deg, var(--primary), var(--primary2)); color:#fff; }
  button.success{ background: linear-gradient(135deg, #16a34a, #15803d); color:#fff; }
  button.danger{ background: linear-gradient(135deg, #ef4444, var(--danger)); color:#fff; }

  /* ‚úÖ SAME stats bar as ESIC (your format) */
  .stats{
    margin: 12px 18px 0;
    background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
    color:#fff;
    border-radius: 12px;
    padding: 12px 14px;
    display:none;
    justify-content: space-between;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    border:1px solid rgba(255,255,255,.06);
  }
  .stats .pill{
    background: rgba(255,255,255,.10);
    padding: 8px 12px;
    border-radius: 999px;
    font-weight: 900;
    font-size: 12px;
  }

  .table-wrapper{
    overflow:auto;
    max-height: calc(100vh - 290px);
  }

  table{ width:100%; border-collapse:collapse; font-size:13px; }
  th, td{ border:1px solid #eef2f7; padding:10px; vertical-align:top; }

  thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
    color: var(--theadText);
    text-align:center;
    font-weight:900;
    white-space:nowrap;
    border-color: rgba(255,255,255,.06);
  }

  tbody tr:nth-child(even){ background:#fafcff; }
  tbody tr:hover{ background:#f3f7ff; }

  td.numeric{
    text-align:right;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    white-space: nowrap;
  }
  td.wrap{ white-space: normal; word-break: break-word; }
  .empty-state{ text-align:center; color:#94a3b8; font-weight:800; }

  .note{
    margin: 14px 18px 18px;
    padding: 12px 14px;
    background: #f8fafc;
    border-left:4px solid #2563eb;
    font-size: 13px;
    border-radius: 10px;
    color:#334155;
  }
</style>
</head>

<body>
  <div class="shell">

    <div class="topbar">
      <div class="brand">
        <img src="wop-logo.png" alt="WOP Logo" />
        <div class="brand-title">
          <h1>WOP Statutory Challan Xtract</h1>
          <p>Extract Income Tax challan receipts into Excel-ready tables</p>
        </div>
      </div>

      <div class="follow-bar">
        <span class="follow-label">Follow us:</span>
        <a class="social-btn li" href="https://www.linkedin.com/in/thangaraju-s/" target="_blank" rel="noopener">LinkedIn</a>
        <a class="social-btn wa" href="https://whatsapp.com/channel/0029VaeUJacEgGfE1V9taa2u" target="_blank" rel="noopener">WhatsApp</a>
        <a class="social-btn ig" href="https://www.instagram.com/world_of_professionals/" target="_blank" rel="noopener">Instagram</a>
        <span class="follow-sep2">|</span>
        <span class="follow-mail">Queries & Feedback:
          <a href="mailto:worldofprofessionalsin@gmail.com">worldofprofessionalsin@gmail.com</a>
        </span>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="left">
          <div class="title">Upload and Extract</div>
          <div class="sub">Select multiple Income Tax challan PDF(s) and click Extract.</div>
        </div>

        <div class="controls">
          <div class="file">
            <span>Choose PDFs</span>
            <input type="file" id="fileInput" multiple accept=".pdf" />
          </div>

          <span id="fileCount" style="font-weight:900;color:#334155;">No files selected</span>

          <button class="primary" id="extractBtn">üîç Extract Data</button>
          <button class="success" id="exportBtn" disabled>üì• Export</button>
          <button class="danger" id="clearBtn" disabled>üßπ Clear</button>
        </div>
      </div>

      <!-- ‚úÖ SAME ESIC stats layout -->
      <div class="stats" id="stats">
        <div class="pill">Total Records: <span id="totalRecords">0</span></div>
        <div class="pill">Total Amount (‚Çπ): <span id="totalAmount">0</span></div>
      </div>

      <div class="table-wrapper">
        <table id="resultTable">
          <thead>
            <tr>
              <th>#</th>
              <th>TAN</th>
              <th>Name</th>
              <th>Assessment Year</th>
              <th>Financial Year</th>
              <th>Major Head</th>
              <th>Minor Head</th>
              <th>Nature of Payment</th>
              <th>Amount (Rs.)</th>

              <th>CIN</th>
              <th>Mode of Payment</th>
              <th>Bank Name</th>
              <th>Bank Reference No</th>
              <th>Date of Deposit</th>
              <th>BSR code</th>
              <th>Challan No</th>
              <th>Tender Date</th>

              <th>Tax (A)</th>
              <th>Surcharge (B)</th>
              <th>Cess (C)</th>
              <th>Interest (D)</th>
              <th>Penalty (E)</th>
              <th>Fee u/s 234E / Others (F)</th>
              <th>Others (F)</th>
              <th>Total (A+B+C+D+E+F)</th>

              <th>File Name</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty-state">
              <td colspan="27">No data yet. Upload Income Tax challan receipts.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="note">
        ‚úî Removes ITNS no.<br />
        ‚úî Supports ‚ÄúOthers (F)‚Äù cases (keeps column blank if not present)<br />
        ‚úî Excel export is fully client-side browser
      </div>
    </div>

  </div>

<script>
/* ================= Helpers ================= */

function clean(s){
  return (s||"")
    .replace(/\u00a0/g," ")
    .replace(/[ \t]+/g," ")
    .replace(/\s*:\s*/g," : ")
    .replace(/\s{2,}/g," ")
    .trim();
}

function normalizeAmountText(t){
  return String(t||"").replace(/‚Çπ/g,"").trim();
}

function pickAmountAny(text){
  const s = normalizeAmountText(text);
  const m =
    s.match(/([0-9]{1,3}(?:,[0-9]{2,3})+(?:\.[0-9]+)?|[0-9]+(?:\.[0-9]+)?)/);
  return m ? m[1] : "";
}

function parseAmount(a){
  if(!a) return 0;
  const n = Number(String(a).replace(/,/g,""));
  return Number.isFinite(n) ? n : 0;
}

function formatINR(n){
  return Number(n || 0).toLocaleString("en-IN",{minimumFractionDigits:2, maximumFractionDigits:2});
}

function pickDateLike(v){
  const s = String(v||"");
  const m =
    s.match(/(\d{1,2}-[A-Za-z]{3}-\d{4})/) ||
    s.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
  return m ? m[1] : "";
}

function pickField(lines, labelRe, lookahead=3){
  const idx = lines.findIndex(l => labelRe.test(l));
  if(idx === -1) return "";

  for(let i=idx; i<=Math.min(idx+lookahead, lines.length-1); i++){
    const line = lines[i];

    if(i===idx){
      const colonIdx = line.indexOf(" : ");
      if(colonIdx !== -1){
        const v = clean(line.slice(colonIdx + 3));
        if(v) return v;
      }
      const m = line.match(labelRe);
      if(m){
        const rest = clean(line.replace(m[0], "").replace(/^[:\-\s]+/, ""));
        if(rest) return rest;
      }
    }else{
      const candidate = clean(line);
      if(candidate) return candidate;
    }
  }
  return "";
}

function sliceAfter(lines, startRe){
  const idx = lines.findIndex(l => startRe.test(l));
  return idx === -1 ? [] : lines.slice(idx);
}

// Find breakup line for a row letter A..F
function findBreakupLine(lines, letter){
  const re = new RegExp("^\\s*" + letter + "\\s+", "i");
  return lines.find(l => re.test(l)) || "";
}

// Get amount from a breakup line
function amountFromBreakupLine(line){
  return pickAmountAny(line);
}

function pickTotalFromBreakup(lines){
  for(const ln of lines){
    if(/\bTotal\s*\(A\+B\+C\+D\+E\+F\)\b/i.test(ln)){
      const a = pickAmountAny(ln);
      if(a) return a;
    }
  }
  return "";
}

/* ================= PDF Reader (position-based line builder) ================= */

async function readPdfAsLines(file){
  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
  const allLines = [];

  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    const byY = new Map();

    for(const it of content.items){
      const str = clean(it.str);
      if(!str) continue;

      const x = it.transform[4];
      const y = it.transform[5];
      const keyY = Math.round(y * 2) / 2;

      if(!byY.has(keyY)) byY.set(keyY, []);
      byY.get(keyY).push({ x, str });
    }

    const ys = Array.from(byY.keys()).sort((a,b)=>b-a);

    for(const y of ys){
      const parts = byY.get(y).sort((a,b)=>a.x-b.x).map(o=>o.str);
      const line = clean(parts.join(" "));
      if(line) allLines.push(line);
    }
  }

  return allLines;
}

/* ================= UI Logic ================= */

let extractedData = [];

fileInput.onchange = e => {
  fileCount.textContent = e.target.files.length
    ? `${e.target.files.length} file(s) selected`
    : "No files selected";
};

function renderTable(){
  const tb = document.querySelector("#resultTable tbody");
  tb.innerHTML = "";

  if(!extractedData.length){
    tb.innerHTML = `<tr class="empty-state"><td colspan="27">No data yet. Upload Income Tax challan receipts.</td></tr>`;
    return;
  }

  extractedData.forEach((r,i)=>{
    const tr=document.createElement("tr");

    const cells = [
      i+1,
      r.tan, r.name, r.ay, r.fy, r.maj, r.min, r.nop, r.amount,
      r.cin, r.mode, r.bank, r.brn, r.dep, r.bsr, r.chNo, r.ten,
      r.taxA, r.surB, r.cesC, r.intD, r.penE, r.feeF, r.othersF, r.total,
      r.file
    ];

    cells.forEach((v, idx)=>{
      const td=document.createElement("td");
      td.textContent = v || "";
      if([8,17,18,19,20,21,22,23,24].includes(idx)) td.className="numeric";
      if([2,9,12,26].includes(idx)) td.classList.add("wrap");
      tr.appendChild(td);
    });

    tb.appendChild(tr);
  });
}

function updateStats(){
  const statsEl = document.getElementById("stats");
  statsEl.style.display = extractedData.length ? "flex" : "none";
  document.getElementById("totalRecords").textContent = extractedData.length;

  const sum = extractedData.reduce((s,r)=> s + parseAmount(r.amount), 0);
  document.getElementById("totalAmount").textContent = formatINR(sum);
}

/* ================= Extract ================= */

async function doExtract(){
  const files = [...fileInput.files];
  if(!files.length){ alert("Select PDF files"); return; }

  extractedData = [];

  for(const f of files){
    const lines = await readPdfAsLines(f);

    // ‚úÖ remove ITNS no (skip extracting it completely)
    const tan  = pickField(lines, /\bTAN\b/i);
    const name = pickField(lines, /\bName\b/i);
    const ay   = pickField(lines, /\bAssessment\s*Year\b/i);
    const fy   = pickField(lines, /\bFinancial\s*Year\b/i);
    const maj  = pickField(lines, /\bMajor\s*Head\b/i);
    const min  = pickField(lines, /\bMinor\s*Head\b/i);
    const nop  = pickField(lines, /\bNature\s*of\s*Payment\b/i);

    const amtCandidates = [
      pickField(lines, /\bAmount\s*\(in\s*Rs\.\)\b/i),
      pickField(lines, /\bAmount\s*\(in\s*‚Çπ\)\b/i),
      pickField(lines, /\bAmount\b/i)
    ].filter(Boolean).join(" | ");

    const cin  = pickField(lines, /\bCIN\b/i);
    const mode = pickField(lines, /\bMode\s*of\s*Payment\b/i);
    const bank = pickField(lines, /\bBank\s*Name\b/i);
    const brn  = pickField(lines, /\bBank\s*Reference\s*Number\b/i);
    const dep  = pickField(lines, /\bDate\s*of\s*Deposit\b/i);
    const bsr  = pickField(lines, /\bBSR\s*code\b/i);
    const chNo = pickField(lines, /\bChallan\s*No\b/i);
    const ten  = pickField(lines, /\bTender\s*Date\b/i);

    const breakupLines = sliceAfter(lines, /\bTax\s*Breakup\s*Details\b/i);

    const lineA = findBreakupLine(breakupLines, "A");
    const lineB = findBreakupLine(breakupLines, "B");
    const lineC = findBreakupLine(breakupLines, "C");
    const lineD = findBreakupLine(breakupLines, "D");
    const lineE = findBreakupLine(breakupLines, "E");
    const lineF = findBreakupLine(breakupLines, "F");

    const taxA = amountFromBreakupLine(lineA);
    const surB = amountFromBreakupLine(lineB);
    const cesC = amountFromBreakupLine(lineC);
    const intD = amountFromBreakupLine(lineD);
    const penE = amountFromBreakupLine(lineE);

    // ‚úÖ F handling: no either/or logic, just fill if present else blank
    const feeF = amountFromBreakupLine(lineF);                 // may be fee u/s 234E or Others
    const othersF = /\bOthers\b/i.test(lineF) ? feeF : "";      // if it is "Others" keep here too, else blank

    let total = pickTotalFromBreakup(breakupLines);

    // total fallback: compute from A..F
    if(!total){
      const computed =
        parseAmount(taxA)+parseAmount(surB)+parseAmount(cesC)+
        parseAmount(intD)+parseAmount(penE)+parseAmount(feeF);
      if(computed > 0) total = computed.toLocaleString("en-IN");
    }

    // amount fallback: use total if amount missing
    let amount = pickAmountAny(amtCandidates);
    if(!amount && total) amount = total;

    extractedData.push({
      tan: clean(tan),
      name: clean(name),
      ay: clean(ay),
      fy: clean(fy),
      maj: clean(maj),
      min: clean(min),
      nop: clean(nop),
      amount: amount || "",

      cin: clean(cin),
      mode: clean(mode),
      bank: clean(bank),
      brn: clean(brn),
      dep: pickDateLike(dep) || clean(dep),
      bsr: clean(bsr),
      chNo: clean(chNo),
      ten: pickDateLike(ten) || clean(ten),

      taxA, surB, cesC, intD, penE, feeF, othersF,
      total: total || "",

      file: f.name
    });
  }

  renderTable();
  updateStats();
  exportBtn.disabled = !extractedData.length;
  clearBtn.disabled = false;
}

/* ================= Export ================= */

function exportExcel(){
  if(!extractedData.length) return alert("No data to export");

  const header = [
    "#","TAN","Name","Assessment Year","Financial Year","Major Head","Minor Head","Nature of Payment","Amount (Rs.)",
    "CIN","Mode of Payment","Bank Name","Bank Reference No","Date of Deposit","BSR code","Challan No","Tender Date",
    "Tax (A)","Surcharge (B)","Cess (C)","Interest (D)","Penalty (E)","Fee u/s 234E / Others (F)","Others (F)","Total (A+B+C+D+E+F)",
    "File Name"
  ];

  const data = [header];

  extractedData.forEach((r,i)=>{
    data.push([
      i+1,
      r.tan, r.name, r.ay, r.fy, r.maj, r.min, r.nop,
      parseAmount(r.amount) ? parseAmount(r.amount) : (r.amount || ""),
      r.cin, r.mode, r.bank, r.brn, r.dep, r.bsr, r.chNo, r.ten,
      r.taxA, r.surB, r.cesC, r.intD, r.penE, r.feeF, r.othersF, r.total,
      r.file
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);

  ws["!cols"] = [
    {wch:5},{wch:16},{wch:40},{wch:14},{wch:14},{wch:18},{wch:18},{wch:24},{wch:14},
    {wch:30},{wch:18},{wch:18},{wch:20},{wch:14},{wch:12},{wch:12},{wch:12},
    {wch:12},{wch:14},{wch:12},{wch:12},{wch:12},{wch:18},{wch:12},{wch:18},
    {wch:45}
  ];

  // ‚úÖ Calibri 11 for all cells (same approach as ESIC)
  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let R=range.s.r; R<=range.e.r; ++R){
    for(let C=range.s.c; C<=range.e.c; ++C){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      if(!ws[addr]) continue;
      ws[addr].s = ws[addr].s || {};
      ws[addr].s.font = { name:"Calibri", sz:11 };
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Income Tax");
  XLSX.writeFile(wb, "Income_Tax_Challan_Receipt.xlsx", { cellStyles:true });
}

/* ================= Clear ================= */

function clearAll(){
  extractedData = [];
  document.querySelector("#resultTable tbody").innerHTML =
    `<tr class="empty-state"><td colspan="27">No data yet. Upload Income Tax challan receipts.</td></tr>`;
  document.getElementById("stats").style.display="none";
  exportBtn.disabled = true;
  clearBtn.disabled = true;
  fileInput.value = "";
  fileCount.textContent = "No files selected";
}

/* ================= Events ================= */

extractBtn.onclick = doExtract;
exportBtn.onclick = exportExcel;
clearBtn.onclick = clearAll;
</script>

</body>
</html>
