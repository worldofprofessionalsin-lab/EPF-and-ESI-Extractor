<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WOP Generic PDF Extractor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family:Segoe UI,Arial;
  background:#0f172a;
  padding:20px;
  color:#111;
}
.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  max-width:1600px;
  margin:auto;
}
.controls{
  display:flex;
  gap:10px;
  margin-bottom:14px;
  flex-wrap:wrap;
}
button{
  padding:10px 14px;
  font-weight:800;
  border-radius:10px;
  border:none;
  cursor:pointer;
}
.primary{background:#2563eb;color:#fff}
.success{background:#16a34a;color:#fff}
.danger{background:#dc2626;color:#fff}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #e5e7eb;
  padding:8px;
  vertical-align:top;
}
thead th{
  background:#020617;
  color:#fff;
  position:sticky;
  top:0;
}
td.wrap{
  white-space:normal;
  word-break:break-word;
}
.empty{
  text-align:center;
  color:#64748b;
  font-weight:800;
}
</style>
</head>

<body>

<div class="card">
  <h2>üìÑ Generic PDF Key‚ÄìValue Extractor</h2>

  <div class="controls">
    <input type="file" id="fileInput" multiple accept=".pdf">
    <button class="primary" id="extractBtn">üîç Extract</button>
    <button class="success" id="exportBtn" disabled>üì• Export Excel</button>
    <button class="danger" id="clearBtn" disabled>üßπ Clear</button>
  </div>

  <div style="overflow:auto;max-height:70vh">
    <table id="resultTable">
      <thead></thead>
      <tbody>
        <tr class="empty">
          <td>No data. Upload PDFs.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* ================= UTIL ================= */

function norm(t){
  return (t||"").replace(/\s+/g," ").trim();
}

/* ================= READ PDF WITH POSITIONS ================= */

async function readPDF(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  const items = [];

  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const text = await page.getTextContent();
    text.items.forEach(i=>{
      items.push({
        text: norm(i.str),
        x: Math.round(i.transform[4]),
        y: Math.round(i.transform[5])
      });
    });
  }
  return items;
}

/* ================= BUILD LEFT / RIGHT ROWS ================= */

function buildRows(items){
  if(!items.length) return [];

  const xs = items.map(i=>i.x).sort((a,b)=>a-b);
  const midX = xs[Math.floor(xs.length/2)];

  const rows = {};
  items.forEach(i=>{
    const y = Math.round(i.y/2)*2;
    rows[y] = rows[y] || [];
    rows[y].push(i);
  });

  return Object.values(rows).map(r=>{
    return {
      left: r.filter(i=>i.x<=midX).map(i=>i.text).join(" ").trim(),
      right: r.filter(i=>i.x>midX).map(i=>i.text).join(" ").trim()
    };
  });
}

/* ================= GENERIC COLON PARSER ================= */

function parseKeyValue(rows){
  const record = {};
  let lastKey = null;

  rows.forEach(r=>{
    const L = r.left;
    const R = r.right;

    // Case 1: "Header : Value" on left
    if(L.includes(":")){
      const idx = L.indexOf(":");
      const key = L.slice(0,idx).trim();
      const val = (L.slice(idx+1).trim() || R || "");
      if(key){
        record[key] = val;
        lastKey = key;
      }
      return;
    }

    // Case 2: Header left, value right
    if(L && R){
      record[L] = R;
      lastKey = L;
      return;
    }

    // Case 3: continuation line (financial blocks)
    if(!L && R && lastKey){
      record[lastKey] += " " + R;
      return;
    }

    if(L && !R){
      record[L] = record[L] || "";
      lastKey = L;
    }
  });

  return record;
}

/* ================= TABLE ================= */

function collectHeaders(data){
  const set = new Set();
  data.forEach(r=>{
    Object.keys(r).forEach(k=>set.add(k));
  });
  return [...set];
}

function renderTable(data){
  const table = document.getElementById("resultTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");

  if(!data.length){
    thead.innerHTML="";
    tbody.innerHTML=`<tr class="empty"><td>No data</td></tr>`;
    return;
  }

  const headers = collectHeaders(data);

  thead.innerHTML = `
    <tr>
      <th>#</th>
      ${headers.map(h=>`<th>${h}</th>`).join("")}
    </tr>
  `;

  tbody.innerHTML = "";

  data.forEach((row,i)=>{
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        ${headers.map(h=>`<td class="wrap">${row[h]||""}</td>`).join("")}
      </tr>
    `;
  });
}

/* ================= EXCEL ================= */

function exportExcel(data){
  const headers = collectHeaders(data);
  const aoa = [["#", ...headers]];

  data.forEach((r,i)=>{
    aoa.push([i+1, ...headers.map(h=>r[h]||"")]);
  });

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "PDF");
  XLSX.writeFile(wb, "PDF_Extract.xlsx");
}

/* ================= EVENTS ================= */

let extracted = [];

extractBtn.onclick = async ()=>{
  const files = [...fileInput.files];
  if(!files.length){ alert("Select PDFs"); return; }

  extracted = [];

  for(const f of files){
    const items = await readPDF(f);
    const rows = buildRows(items);
    extracted.push(parseKeyValue(rows));
  }

  renderTable(extracted);
  exportBtn.disabled = !extracted.length;
  clearBtn.disabled = !extracted.length;
};

exportBtn.onclick = ()=> exportExcel(extracted);

clearBtn.onclick = ()=>{
  extracted=[];
  renderTable([]);
  exportBtn.disabled=true;
  clearBtn.disabled=true;
  fileInput.value="";
};
</script>

</body>
</html>
