<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>WOP Statutory Challan Xtract</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --bg1:#0b1220;
    --bg2:#0f1b33;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e5e7eb;
    --shadow:0 18px 55px rgba(2,6,23,.25);

    --primary:#2563eb;
    --primary2:#1d4ed8;
    --success:#16a34a;
    --danger:#dc2626;

    --header:#0b1220;
    --thead:#0f172a;
    --theadText:#ffffff;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: "Segoe UI", Arial, sans-serif;
    color: var(--text);
    min-height:100vh;
    background:
      radial-gradient(1200px 600px at 15% 10%, rgba(37,99,235,.25), transparent 55%),
      radial-gradient(900px 500px at 85% 0%, rgba(16,185,129,.18), transparent 55%),
      linear-gradient(160deg, var(--bg1) 0%, var(--bg2) 100%);
    padding: 28px 18px;
  }

  .shell{
    max-width: 1700px;
    margin: 0 auto;
  }

  /* App header */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    padding:16px 18px;
    border-radius:16px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 35px rgba(0,0,0,.20);
    margin-bottom: 16px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    min-width: 260px;
  }

  .brand img{
    width:46px;
    height:46px;
    border-radius:12px;
    background:#fff;
    padding:6px;
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
    object-fit:contain;
  }

  .brand-title{
    display:flex;
    flex-direction:column;
    line-height:1.1;
  }

  .brand-title h1{
    color:#fff;
    font-size:18px;
    font-weight:900;
    letter-spacing:.2px;
  }

  .brand-title p{
    color: rgba(255,255,255,.72);
    font-size:12px;
    margin-top:4px;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    color: rgba(255,255,255,.78);
    font-size:12px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    white-space:nowrap;
  }

  /* Main card */
  .card{
    background: var(--card);
    border-radius: 18px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(2,6,23,.08);
    overflow:hidden;
  }

  .card-head{
    padding:16px 18px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
  }

  .card-head .left{
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .card-head .left .title{
    font-size:14px;
    font-weight:900;
    color: var(--text);
  }
  .card-head .left .sub{
    font-size:12px;
    color: var(--muted);
  }

  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .file{
    position:relative;
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    min-width: 280px;
  }
  .file span{
    color: var(--muted);
    font-size:12px;
    white-space:nowrap;
  }
  input[type="file"]{
    width: 100%;
    font-size:12px;
  }

  button{
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    padding:10px 14px;
    display:inline-flex;
    gap:8px;
    align-items:center;
    box-shadow: 0 8px 20px rgba(2,6,23,.10);
    transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease;
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(2,6,23,.14); }
  button:active{ transform: translateY(0); opacity:.92; }

  button.primary{ background: linear-gradient(135deg, var(--primary), var(--primary2)); color:#fff; }
  button.success{ background: linear-gradient(135deg, #16a34a, #15803d); color:#fff; }
  button.danger{ background: linear-gradient(135deg, #ef4444, var(--danger)); color:#fff; }

  /* Table */
  .table-wrapper{
    overflow:auto;
    max-height: calc(100vh - 240px);
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }

  th, td{
    border:1px solid #eef2f7;
    padding:10px;
    vertical-align:top;
  }

  thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
    color: var(--theadText);
    text-align:center;
    font-weight:900;
    white-space:nowrap;
    border-color: rgba(255,255,255,.06);
  }

  tbody tr:nth-child(even){ background:#fafcff; }
  tbody tr:hover{ background:#f3f7ff; }

  td.numeric{
    text-align:right;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    white-space:nowrap;
  }
  td.wrap{
    white-space:normal;
    word-break:break-word;
  }
  .empty{
    text-align:center;
    color:#94a3b8;
    font-weight:700;
  }
  .follow-bar{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.follow-label{
  color: rgba(255,255,255,.75);
  font-size:12px;
  font-weight:800;
}

.social-btn{
  text-decoration:none;
  font-weight:900;
  font-size:12px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.08);
  color:#fff;
  transition: transform .08s ease, background .08s ease, opacity .08s ease;
  box-shadow: 0 10px 22px rgba(0,0,0,.15);
}

.social-btn:hover{
  background: rgba(255,255,255,.14);
  transform: translateY(-1px);
}

.social-btn:active{
  transform: translateY(0);
  opacity:.92;
}

/* subtle brand tints */
.social-btn.li{ border-color: rgba(10,102,194,.45); }
.social-btn.wa{ border-color: rgba(37,211,102,.45); }
.social-btn.ig{ border-color: rgba(225,48,108,.45); }

.follow-sep2{
  color: rgba(255,255,255,.30);
  font-weight:900;
  margin:0 2px;
}

.follow-mail{
  color: rgba(255,255,255,.75);
  font-size:12px;
  font-weight:800;
}

.follow-mail a{
  color:#93c5fd;
  text-decoration:none;
  font-weight:900;
}
.follow-mail a:hover{ text-decoration:underline; }

</style>
</head>

<body>
  <div class="shell">

    <div class="topbar">
      <div class="brand">
        <!-- ‚úÖ Put your logo file in same folder and name it wop-logo.png -->
        <img src="wop-logo.png" alt="WOP Logo" />
        <div class="brand-title">
          <h1>WOP Statutory Challan Xtract</h1>
          <p>Extract EPF payment receipts into Excel-ready tables</p>
        </div>
      </div>

      <div class="follow-bar">
  <span class="follow-label">Follow us:</span>

  <a class="social-btn li" href="https://www.linkedin.com/in/thangaraju-s/" target="_blank" rel="noopener">
    LinkedIn
  </a>

  <a class="social-btn wa" href="https://whatsapp.com/channel/0029VaeUJacEgGfE1V9taa2u" target="_blank" rel="noopener">
    WhatsApp
  </a>

  <a class="social-btn ig" href="https://www.instagram.com/world_of_professionals/" target="_blank" rel="noopener">
    Instagram
  </a>

  <span class="follow-sep2">|</span>

  <span class="follow-mail">
    Queries & Feedback:
    <a href="mailto:worldofprofessionalsin@gmail.com">worldofprofessionalsin@gmail.com</a>
  </span>
</div>


    </div>

    <div class="card">
      <div class="card-head">
        <div class="left">
          <div class="title">Upload and Extract</div>
          <div class="sub">Select multiple EPF Payment Receipt PDFs and click Extract.</div>
        </div>

        <div class="controls">
          <div class="file">
            <span>Choose PDFs</span>
            <input type="file" id="fileInput" multiple accept=".pdf" />
          </div>
          <button class="primary" onclick="extract()">üîç Extract</button>
          <button class="success" onclick="exportExcel()">üì• Export</button>
          <button class="danger" onclick="clearAll()">üßπ Clear</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>TRRN No</th>
              <th>Challan Status</th>
              <th>Challan Generated On</th>
              <th>Establishment ID</th>
              <th>Establishment Name</th>
              <th>Challan Type</th>
              <th>Total Members</th>
              <th>Wage Month</th>
              <th>Total Amount</th>
              <th>Account-1 Amount</th>
              <th>Account-2 Amount</th>
              <th>Account-10 Amount</th>
              <th>Account-21 Amount</th>
              <th>Account-22 Amount</th>
              <th>Payment Confirmation Bank</th>
              <th>CRN</th>
              <th>Payment Date</th>
              <th>Payment Confirmation Date</th>
              <th>File Name</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr class="empty"><td colspan="19">Upload EPF Payment Receipt PDFs</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
  

<script>
let rows = [];

/* -------------------- Helpers -------------------- */
function clean(s){
  return (s||"")
    .replace(/\u00a0/g," ")
    .replace(/[ \t]+/g," ")
    .replace(/\s*:\s*/g," : ")
    .replace(/\s{2,}/g," ")
    .trim();
}

function firstMatch(text, re){
  const m = text.match(re);
  return m ? m[1] : "";
}

// Extract value after ":" in a reconstructed line
function valueAfterColon(line){
  const idx = line.indexOf(" : ");
  if(idx === -1) return "";
  return clean(line.slice(idx + 3));
}

function pickFromLines(lines, labelRegex){
  const line = lines.find(l => labelRegex.test(l));
  if(!line) return "";
  return valueAfterColon(line);
}

function pickNumberLike(v){
  const s = String(v||"");
  const m = s.match(/([0-9]{1,3}(?:,[0-9]{2,3})+|[0-9]+)/);
  return m ? m[1] : "";
}

function pickDateLike(v){
  const s = String(v||"");
  const m = s.match(/(\d{1,2}-[A-Z]{3}-\d{4}(?:\s+\d{1,2}\s*:\s*\d{2}\s*:\s*\d{2})?)/i);
  return m ? m[1].replace(/\s+/g," ").replace(/\s*:\s*/g,":") : "";
}

/* -------------------- PDF position-based line builder -------------------- */
async function readPdfAsLines(file){
  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
  const allLines = [];

  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    const byY = new Map();

    for(const it of content.items){
      const str = clean(it.str);
      if(!str) continue;

      const x = it.transform[4];
      const y = it.transform[5];

      const keyY = Math.round(y * 2) / 2;

      if(!byY.has(keyY)) byY.set(keyY, []);
      byY.get(keyY).push({ x, str });
    }

    const ys = Array.from(byY.keys()).sort((a,b)=>b-a);

    for(const y of ys){
      const parts = byY.get(y).sort((a,b)=>a.x-b.x).map(o=>o.str);
      const line = clean(parts.join(" "));
      if(line) allLines.push(line);
    }
  }

  return allLines;
}

/* -------------------- Extract -------------------- */
async function extract(){
  const files = [...fileInput.files];
  if(!files.length) return alert("Select PDF files");

  rows = [];
  tbody.innerHTML = "";

  for(const f of files){
    const lines = await readPdfAsLines(f);

    let trrn = pickFromLines(lines, /\bTRRN\s*No\b/i);
    trrn = firstMatch(trrn, /(\d{13})/);

    const status = pickFromLines(lines, /\bChallan\s*Status\b/i);
    const challanGenOnRaw = pickFromLines(lines, /\bChallan\s*Generated\s*On\b/i);

    const estIdRaw = pickFromLines(lines, /\bEstablishment\s*ID\b/i);
    const estNameRaw = pickFromLines(lines, /\bEstablishment\s*Name\b/i);

    const challanTypeRaw = pickFromLines(lines, /\bChallan\s*Type\b/i);
    const totalMembersRaw = pickFromLines(lines, /\bTotal\s*Members\b/i);
    const wageMonthRaw = pickFromLines(lines, /\bWage\s*Month\b/i);

    const totalAmountRaw = pickFromLines(lines, /\bTotal\s*Amount\b/i);

    const acc1Raw = pickFromLines(lines, /\bAccount\s*-?\s*1\b/i);
    const acc2Raw = pickFromLines(lines, /\bAccount\s*-?\s*2\b/i);
    const acc10Raw = pickFromLines(lines, /\bAccount\s*-?\s*10\b/i);
    const acc21Raw = pickFromLines(lines, /\bAccount\s*-?\s*21\b/i);
    const acc22Raw = pickFromLines(lines, /\bAccount\s*-?\s*22\b/i);

    const bankRaw = pickFromLines(lines, /\bPayment\s*Confirmation\s*Bank\b/i);
    const crnRaw  = pickFromLines(lines, /\bCRN\b/i);
    const payDateRaw = pickFromLines(lines, /\bPayment\s*Date\b/i);
    const payConfDateRaw = pickFromLines(lines, /\bPayment\s*Confirmation\s*Date\b/i);

    rows.push({
      "TRRN No": trrn,
      "Challan Status": clean(status),
      "Challan Generated On": pickDateLike(challanGenOnRaw) || clean(challanGenOnRaw),
      "Establishment ID": clean(estIdRaw),
      "Establishment Name": clean(estNameRaw),
      "Challan Type": clean(challanTypeRaw),
      "Total Members": pickNumberLike(totalMembersRaw) || clean(totalMembersRaw),
      "Wage Month": clean(wageMonthRaw),
      "Total Amount": pickNumberLike(totalAmountRaw) || clean(totalAmountRaw),
      "Account-1 Amount": pickNumberLike(acc1Raw) || clean(acc1Raw),
      "Account-2 Amount": pickNumberLike(acc2Raw) || clean(acc2Raw),
      "Account-10 Amount": pickNumberLike(acc10Raw) || clean(acc10Raw),
      "Account-21 Amount": pickNumberLike(acc21Raw) || clean(acc21Raw),
      "Account-22 Amount": pickNumberLike(acc22Raw) || clean(acc22Raw),
      "Payment Confirmation Bank": clean(bankRaw),
      "CRN": pickNumberLike(crnRaw) || clean(crnRaw),
      "Payment Date": pickDateLike(payDateRaw) || clean(payDateRaw),
      "Payment Confirmation Date": pickDateLike(payConfDateRaw) || clean(payConfDateRaw),
      "File Name": f.name
    });
  }

  render();
}

/* -------------------- Render -------------------- */
function render(){
  tbody.innerHTML = "";

  if(!rows.length){
    tbody.innerHTML = `<tr class="empty"><td colspan="19">No rows extracted</td></tr>`;
    return;
  }

  for(const r of rows){
    tbody.innerHTML += `
      <tr>
        <td class="wrap">${r["TRRN No"]||""}</td>
        <td class="wrap">${r["Challan Status"]||""}</td>
        <td class="wrap">${r["Challan Generated On"]||""}</td>
        <td class="wrap">${r["Establishment ID"]||""}</td>
        <td class="wrap">${r["Establishment Name"]||""}</td>
        <td class="wrap">${r["Challan Type"]||""}</td>
        <td class="numeric">${r["Total Members"]||""}</td>
        <td class="wrap">${r["Wage Month"]||""}</td>
        <td class="numeric">${r["Total Amount"]||""}</td>
        <td class="numeric">${r["Account-1 Amount"]||""}</td>
        <td class="numeric">${r["Account-2 Amount"]||""}</td>
        <td class="numeric">${r["Account-10 Amount"]||""}</td>
        <td class="numeric">${r["Account-21 Amount"]||""}</td>
        <td class="numeric">${r["Account-22 Amount"]||""}</td>
        <td class="wrap">${r["Payment Confirmation Bank"]||""}</td>
        <td class="wrap">${r["CRN"]||""}</td>
        <td class="wrap">${r["Payment Date"]||""}</td>
        <td class="wrap">${r["Payment Confirmation Date"]||""}</td>
        <td class="wrap">${r["File Name"]||""}</td>
      </tr>
    `;
  }
}

/* -------------------- Export -------------------- */
function exportExcel(){
  if(!rows.length) return alert("No data to export");

  const ws = XLSX.utils.json_to_sheet(rows);
  ws["!cols"] = [
    {wch:14},{wch:18},{wch:22},{wch:18},{wch:50},{wch:28},
    {wch:12},{wch:12},{wch:14},{wch:16},{wch:16},{wch:16},
    {wch:16},{wch:16},{wch:22},{wch:18},{wch:14},{wch:22},{wch:40}
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "EPF Payment Receipt");
  XLSX.writeFile(wb, "EPF_Payment_Receipt.xlsx");
}

/* -------------------- Clear -------------------- */
function clearAll(){
  rows = [];
  tbody.innerHTML = `<tr class="empty"><td colspan="19">Upload EPF Payment Receipt PDFs</td></tr>`;
  fileInput.value = "";
}



</script>

</body>
</html>
