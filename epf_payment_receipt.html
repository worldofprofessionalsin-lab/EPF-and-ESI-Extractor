<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EPF Payment Receipt Extractor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:"Segoe UI",Arial,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    padding:20px;
  }
  h1{
    text-align:center;color:#fff;margin-bottom:20px;
    font-weight:900;letter-spacing:.3px;
  }
  .container{
    max-width:1600px;margin:auto;background:#fff;
    padding:22px;border-radius:14px;
    box-shadow:0 10px 40px rgba(0,0,0,.2);
  }
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  button{
    padding:10px 18px;border:none;border-radius:8px;cursor:pointer;
    font-weight:800;display:inline-flex;gap:8px;align-items:center;
  }
  button.primary{background:#1f6fb2;color:#fff}
  button.success{background:#2e8b57;color:#fff}
  button.danger{background:#dc3545;color:#fff}

  .table-wrapper{overflow-x:auto;border:1px solid #e2e8f0;border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid #e2e8f0;padding:10px;vertical-align:top}
  th{
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#fff;text-align:center;font-weight:900;white-space:nowrap;
  }
  td.numeric{
    text-align:right;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    white-space:nowrap;
  }
  td.wrap{white-space:normal;word-break:break-word}
  .empty{text-align:center;color:#94a3b8}
</style>
</head>

<body>
<h1>üßæ EPF Payment Receipt Extractor</h1>

<div class="container">
  <div class="controls">
    <input type="file" id="fileInput" multiple accept=".pdf" />
    <button class="primary" onclick="extract()">üîç Extract</button>
    <button class="success" onclick="exportExcel()">üì• Export</button>
    <button class="danger" onclick="clearAll()">üßπ Clear</button>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>TRRN No</th>
          <th>Challan Status</th>
          <th>Challan Generated On</th>
          <th>Establishment ID</th>
          <th>Establishment Name</th>
          <th>Challan Type</th>
          <th>Total Members</th>
          <th>Wage Month</th>
          <th>Total Amount</th>
          <th>Account-1 Amount</th>
          <th>Account-2 Amount</th>
          <th>Account-10 Amount</th>
          <th>Account-21 Amount</th>
          <th>Account-22 Amount</th>
          <th>Payment Confirmation Bank</th>
          <th>CRN</th>
          <th>Payment Date</th>
          <th>Payment Confirmation Date</th>
          <th>File Name</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr class="empty"><td colspan="19">Upload EPF Payment Receipt PDFs</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
let rows = [];

/* -------------------- Helpers -------------------- */
function clean(s){
  return (s||"")
    .replace(/\u00a0/g," ")
    .replace(/[ \t]+/g," ")
    .replace(/\s*:\s*/g," : ")
    .replace(/\s{2,}/g," ")
    .trim();
}

function firstMatch(text, re){
  const m = text.match(re);
  return m ? m[1] : "";
}

// Extract value after ":" in a reconstructed line
function valueAfterColon(line){
  const idx = line.indexOf(" : ");
  if(idx === -1) return "";
  return clean(line.slice(idx + 3));
}

function pickFromLines(lines, labelRegex){
  // find first line that contains the label
  const line = lines.find(l => labelRegex.test(l));
  if(!line) return "";
  // if line has colon, take right side, else empty
  const v = valueAfterColon(line);
  return v;
}

function pickNumberLike(v){
  // returns first number with commas (or plain digits)
  const s = String(v||"");
  const m = s.match(/([0-9]{1,3}(?:,[0-9]{2,3})+|[0-9]+)/);
  return m ? m[1] : "";
}

function pickDateLike(v){
  // handles 12-JUN-2024 or 12-JUN-2024 13:28:21 etc.
  const s = String(v||"");
  const m = s.match(/(\d{1,2}-[A-Z]{3}-\d{4}(?:\s+\d{1,2}\s*:\s*\d{2}\s*:\s*\d{2})?)/i);
  return m ? m[1].replace(/\s+/g," ").replace(/\s*:\s*/g,":") : "";
}

/* -------------------- PDF position-based line builder -------------------- */
/**
 * Build lines using text item coordinates.
 * Key trick: group items by Y, then sort each line by X (left to right).
 * This fixes your ‚Äúshifted columns‚Äù issue.
 */
async function readPdfAsLines(file){
  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
  const allLines = [];

  for(let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();

    // group by approximate Y coordinate
    const byY = new Map();

    for(const it of content.items){
      const str = clean(it.str);
      if(!str) continue;

      const x = it.transform[4];
      const y = it.transform[5];

      // rounding y groups items on same line (tweak 2 if needed)
      const keyY = Math.round(y * 2) / 2;

      if(!byY.has(keyY)) byY.set(keyY, []);
      byY.get(keyY).push({ x, str });
    }

    // sort lines top->bottom (higher y first)
    const ys = Array.from(byY.keys()).sort((a,b)=>b-a);

    for(const y of ys){
      const parts = byY.get(y).sort((a,b)=>a.x-b.x).map(o=>o.str);
      const line = clean(parts.join(" "));
      if(line) allLines.push(line);
    }
  }

  return allLines;
}

/* -------------------- Extract -------------------- */
async function extract(){
  const files = [...fileInput.files];
  if(!files.length) return alert("Select PDF files");

  rows = [];
  tbody.innerHTML = "";

  for(const f of files){
    const lines = await readPdfAsLines(f);

    // pick values from correctly rebuilt rows
    let trrn = pickFromLines(lines, /\bTRRN\s*No\b/i);
    trrn = firstMatch(trrn, /(\d{13})/); // keep only 13-digit TRRN

    const status = pickFromLines(lines, /\bChallan\s*Status\b/i);
    const challanGenOnRaw = pickFromLines(lines, /\bChallan\s*Generated\s*On\b/i);

    const estIdRaw = pickFromLines(lines, /\bEstablishment\s*ID\b/i);
    const estNameRaw = pickFromLines(lines, /\bEstablishment\s*Name\b/i);

    const challanTypeRaw = pickFromLines(lines, /\bChallan\s*Type\b/i);
    const totalMembersRaw = pickFromLines(lines, /\bTotal\s*Members\b/i);
    const wageMonthRaw = pickFromLines(lines, /\bWage\s*Month\b/i);

    const totalAmountRaw = pickFromLines(lines, /\bTotal\s*Amount\b/i);

    const acc1Raw = pickFromLines(lines, /\bAccount\s*-?\s*1\b/i);
    const acc2Raw = pickFromLines(lines, /\bAccount\s*-?\s*2\b/i);
    const acc10Raw = pickFromLines(lines, /\bAccount\s*-?\s*10\b/i);
    const acc21Raw = pickFromLines(lines, /\bAccount\s*-?\s*21\b/i);
    const acc22Raw = pickFromLines(lines, /\bAccount\s*-?\s*22\b/i);

    const bankRaw = pickFromLines(lines, /\bPayment\s*Confirmation\s*Bank\b/i);
    const crnRaw  = pickFromLines(lines, /\bCRN\b/i);
    const payDateRaw = pickFromLines(lines, /\bPayment\s*Date\b/i);
    const payConfDateRaw = pickFromLines(lines, /\bPayment\s*Confirmation\s*Date\b/i);

    rows.push({
      "TRRN No": trrn,
      "Challan Status": clean(status),
      "Challan Generated On": pickDateLike(challanGenOnRaw) || clean(challanGenOnRaw),
      "Establishment ID": clean(estIdRaw),
      "Establishment Name": clean(estNameRaw),
      "Challan Type": clean(challanTypeRaw),
      "Total Members": pickNumberLike(totalMembersRaw) || clean(totalMembersRaw),
      "Wage Month": clean(wageMonthRaw),
      "Total Amount": pickNumberLike(totalAmountRaw) || clean(totalAmountRaw),
      "Account-1 Amount": pickNumberLike(acc1Raw) || clean(acc1Raw),
      "Account-2 Amount": pickNumberLike(acc2Raw) || clean(acc2Raw),
      "Account-10 Amount": pickNumberLike(acc10Raw) || clean(acc10Raw),
      "Account-21 Amount": pickNumberLike(acc21Raw) || clean(acc21Raw),
      "Account-22 Amount": pickNumberLike(acc22Raw) || clean(acc22Raw),
      "Payment Confirmation Bank": clean(bankRaw),
      "CRN": pickNumberLike(crnRaw) || clean(crnRaw),
      "Payment Date": pickDateLike(payDateRaw) || clean(payDateRaw),
      "Payment Confirmation Date": pickDateLike(payConfDateRaw) || clean(payConfDateRaw),
      "File Name": f.name
    });
  }

  render();
}

/* -------------------- Render -------------------- */
function render(){
  tbody.innerHTML = "";

  if(!rows.length){
    tbody.innerHTML = `<tr class="empty"><td colspan="19">No rows extracted</td></tr>`;
    return;
  }

  for(const r of rows){
    tbody.innerHTML += `
      <tr>
        <td class="wrap">${r["TRRN No"]||""}</td>
        <td class="wrap">${r["Challan Status"]||""}</td>
        <td class="wrap">${r["Challan Generated On"]||""}</td>
        <td class="wrap">${r["Establishment ID"]||""}</td>
        <td class="wrap">${r["Establishment Name"]||""}</td>
        <td class="wrap">${r["Challan Type"]||""}</td>
        <td class="numeric">${r["Total Members"]||""}</td>
        <td class="wrap">${r["Wage Month"]||""}</td>
        <td class="numeric">${r["Total Amount"]||""}</td>
        <td class="numeric">${r["Account-1 Amount"]||""}</td>
        <td class="numeric">${r["Account-2 Amount"]||""}</td>
        <td class="numeric">${r["Account-10 Amount"]||""}</td>
        <td class="numeric">${r["Account-21 Amount"]||""}</td>
        <td class="numeric">${r["Account-22 Amount"]||""}</td>
        <td class="wrap">${r["Payment Confirmation Bank"]||""}</td>
        <td class="wrap">${r["CRN"]||""}</td>
        <td class="wrap">${r["Payment Date"]||""}</td>
        <td class="wrap">${r["Payment Confirmation Date"]||""}</td>
        <td class="wrap">${r["File Name"]||""}</td>
      </tr>
    `;
  }
}

/* -------------------- Export -------------------- */
function exportExcel(){
  if(!rows.length) return alert("No data to export");

  const ws = XLSX.utils.json_to_sheet(rows);
  ws["!cols"] = [
    {wch:14},{wch:18},{wch:22},{wch:18},{wch:50},{wch:28},
    {wch:12},{wch:12},{wch:14},{wch:16},{wch:16},{wch:16},
    {wch:16},{wch:16},{wch:22},{wch:18},{wch:14},{wch:22},{wch:40}
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "EPF Payment Receipt");
  XLSX.writeFile(wb, "EPF_Payment_Receipt.xlsx");
}

/* -------------------- Clear -------------------- */
function clearAll(){
  rows = [];
  tbody.innerHTML = `<tr class="empty"><td colspan="19">Upload EPF Payment Receipt PDFs</td></tr>`;
  fileInput.value = "";
}
</script>

</body>
</html>
